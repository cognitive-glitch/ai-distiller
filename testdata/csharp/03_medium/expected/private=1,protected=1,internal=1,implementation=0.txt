<file path="source.cs">
#nullable enable

using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
namespace Constructs.Medium03;
public interface IRepository<TEntity, TKey> where TEntity : IEntity where TKey : notnull {
    public Task AddAsync(entity TEntity, ct CancellationToken);
    public Task<TEntity?> GetAsync(id TKey, ct CancellationToken);
    public Task<bool> RemoveAsync(id TKey, ct CancellationToken);
    public IAsyncEnumerable<TEntity> QueryAsync(Func<TEntity, bool> predicate, ct CancellationToken);
}
public interface IEntity<TKey> {
    private TKey Id { get; }
}
public abstract record EntityBase(Id T) : IEntity {
public class InMemoryRepository<TEntity, TKey> : IRepository where TEntity : EntityBase where TKey : notnull {
    private readonly ConcurrentDictionary<TKey, TEntity> _store = new();
    public Task AddAsync(entity TEntity, ct CancellationToken);
    public Task<TEntity?> GetAsync(id TKey, ct CancellationToken);
    public Task<bool> RemoveAsync(id TKey, ct CancellationToken);
    public async IAsyncEnumerable<TEntity> QueryAsync(Func<TEntity, bool> predicate, ct CancellationToken);
    private void CleanupExpiredEntities();
    protected virtual bool ValidateEntity(entity TEntity);
    internal int GetEntityCount();
}
public class CachedRepository<TEntity, TKey> : IRepository where TEntity : EntityBase where TKey : notnull {
    private readonly IRepository<TEntity, TKey> _innerRepository;
    private readonly ConcurrentDictionary<TKey, TEntity> _cache = new();
    private readonly TimeSpan _cacheExpiry;
    public CachedRepository(IRepository<TEntity, TKey> innerRepository, cacheExpiry TimeSpan);
    public async Task AddAsync(entity TEntity, ct CancellationToken);
    public async Task<TEntity?> GetAsync(id TKey, ct CancellationToken);
    public async Task<bool> RemoveAsync(id TKey, ct CancellationToken);
    public IAsyncEnumerable<TEntity> QueryAsync(Func<TEntity, bool> predicate, ct CancellationToken);
    private void InvalidateCache();
    internal (int CacheSize, int RepositorySize) GetStats();
}
public record User(
    Id Guid,
    string Name,
    string Email,
    bool IsValid) : EntityBase<Guid>(Id) {
    private bool ValidateEmail();
}
public class UserService {
    private readonly IRepository<User, Guid> _userRepository;
    public UserService(IRepository<User, Guid> userRepository);
    public async Task<User?> CreateUserAsync(string name, string email);
    public Task<User?> GetUserAsync(id Guid);
    private static bool IsValidUserData(string name, string email);
}
</file>
